template:
  - sensor:
      - name: "Beste Laadtijd Batterij"
        unique_id: beste_laadtijd_batterij
        icon: mdi:battery-charging
        state: >
          {% set prices = state_attr('sensor.zonneplan_current_electricity_tariff', 'prices_today') %}
          {% set hours = state_attr('sensor.zonneplan_current_electricity_tariff', 'hours_priced_today') %}
          {% set current_hour = now().hour %}
          {% if prices is not none and prices is iterable and hours is not none and hours is iterable and prices|length > current_hour %}
            {% set remaining_prices = prices[current_hour:] %}
            {% set remaining_hours = hours[current_hour:] %}
            {% if remaining_prices|length >= 3 %}
              {% set min_avg = 999 %}
              {% set best_start = 0 %}
              {% for i in range(remaining_prices|length - 2) %}
                {% set window_prices = [remaining_prices[i], remaining_prices[i+1], remaining_prices[i+2]] %}
                {% set avg_price = (window_prices | sum) / 3 %}
                {% if avg_price < min_avg %}
                  {% set min_avg = avg_price %}
                  {% set best_start = i %}
                {% endif %}
              {% endfor %}
              {% if best_start < remaining_hours|length and remaining_hours[best_start] %}
                {% set start_hour = remaining_hours[best_start][11:13] | int(0) %}
                {% set end_hour = start_hour + 3 %}
                {{ start_hour }}:00 - {{ end_hour }}:00 (gem. €{{ min_avg | round(3) }}/kWh)
              {% else %}
                Onbekend
              {% endif %}
            {% else %}
              Niet genoeg resterende uren vandaag
            {% endif %}
          {% else %}
            Geen data beschikbaar
          {% endif %}
          
      - name: "Verbruik Per Dagdeel"
        unique_id: verbruik_per_dagdeel
        unit_of_measurement: "kWh" 
        state: >
          {% set total = states('sensor.connect_energiemeter_electricity_consumption_daily')|float(0) %}
          {{ total|round(2) }}
        attributes:
          dagdelen: >
            {% set consumption_entity = 'sensor.connect_energiemeter_electricity_consumption' %}
            {% set current_hour = now().hour %}
            
            {% set stats = state_attr(consumption_entity, 'hourly_stats') %}
            {% if stats is not none and stats is mapping %}
              {% set ochtend_sum = 0 %}
              {% set middag_sum = 0 %}
              {% set avond_sum = 0 %}
              {% set nacht_sum = 0 %}
              
              {% for hour, value in stats.items() %}
                {% set hour_int = hour|int(0) %}
                {% if 6 <= hour_int < 12 %}
                  {% set ochtend_sum = ochtend_sum + value|float(0) %}
                {% elif 12 <= hour_int < 18 %}
                  {% set middag_sum = middag_sum + value|float(0) %}
                {% elif 18 <= hour_int < 24 %}
                  {% set avond_sum = avond_sum + value|float(0) %}
                {% elif 0 <= hour_int < 6 %}
                  {% set nacht_sum = nacht_sum + value|float(0) %}
                {% endif %}
              {% endfor %}
              
              [
                {"name": "Ochtend (6-12)", "value": {{ ochtend_sum|round(2) }}},
                {"name": "Middag (12-18)", "value": {{ middag_sum|round(2) }}},
                {"name": "Avond (18-24)", "value": {{ avond_sum|round(2) }}},
                {"name": "Nacht (0-6)", "value": {{ nacht_sum|round(2) }}}
              ]
            {% else %}
              []
            {% endif %}

  - sensor:
      - name: "Stroomprijs Histogram"
        unique_id: stroomprijs_histogram
        icon: mdi:chart-histogram
        state: >
          {% set prices = state_attr('sensor.zonneplan_current_electricity_tariff', 'prices_today') %}
          {% if prices is not none and prices is iterable %}
            {{ prices|length }}
          {% else %}
            0
          {% endif %}
        attributes:
          histogramdata: >
            {% set prices = state_attr('sensor.zonneplan_current_electricity_tariff', 'prices_today') %}
            {% if prices is not none and prices is iterable and prices|length > 0 %}
              {% set zeer_laag_count = 0 %}
              {% set laag_count = 0 %}
              {% set gemiddeld_count = 0 %}
              {% set hoog_count = 0 %}
              {% set zeer_hoog_count = 0 %}
              
              {% for price in prices %}
                {% if 0 <= price < 0.15 %}
                  {% set zeer_laag_count = zeer_laag_count + 1 %}
                {% elif 0.15 <= price < 0.20 %}
                  {% set laag_count = laag_count + 1 %}
                {% elif 0.20 <= price < 0.25 %}
                  {% set gemiddeld_count = gemiddeld_count + 1 %}
                {% elif 0.25 <= price < 0.30 %}
                  {% set hoog_count = hoog_count + 1 %}
                {% elif price >= 0.30 %}
                  {% set zeer_hoog_count = zeer_hoog_count + 1 %}
                {% endif %}
              {% endfor %}
              
              [
                {"name": "Zeer Laag", "count": {{ zeer_laag_count }}, "percentage": {{ ((zeer_laag_count / prices|length * 100)|round)|int }}},
                {"name": "Laag", "count": {{ laag_count }}, "percentage": {{ ((laag_count / prices|length * 100)|round)|int }}},
                {"name": "Gemiddeld", "count": {{ gemiddeld_count }}, "percentage": {{ ((gemiddeld_count / prices|length * 100)|round)|int }}},
                {"name": "Hoog", "count": {{ hoog_count }}, "percentage": {{ ((hoog_count / prices|length * 100)|round)|int }}},
                {"name": "Zeer Hoog", "count": {{ zeer_hoog_count }}, "percentage": {{ ((zeer_hoog_count / prices|length * 100)|round)|int }}}
              ]
            {% else %}
              []
            {% endif %}
          prijscategorieën: >
            {% set prices = state_attr('sensor.zonneplan_current_electricity_tariff', 'prices_today') %}
            {% if prices is not none and prices is iterable and prices|length > 0 %}
              {
                "Zeer Laag": {"min": 0, "max": 0.15},
                "Laag": {"min": 0.15, "max": 0.20},
                "Gemiddeld": {"min": 0.20, "max": 0.25},
                "Hoog": {"min": 0.25, "max": 0.30},
                "Zeer Hoog": {"min": 0.30, "max": "geen limiet"}
              }
            {% else %}
              {}
            {% endif %}