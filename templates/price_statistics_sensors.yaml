- sensor:
      - name: "Huidig Tarief"
        unique_id: current_tariff
        state: "{{ states('sensor.zonneplan_current_electricity_tariff')|float(0)|round(4) }}"
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state_class: total
        icon: mdi:currency-eur
        
      - name: "All-in Tarief"
        unique_id: all_in_tariff
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state_class: total
        icon: mdi:currency-eur
        state: >
          {% set base_price = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
          {% set tax = 0.11 %}
          {% set vat = 0.21 %}
          {{ (base_price * (1 + vat) + tax)|round(4) }}
        attributes:
          basis_tarief: "{{ states('sensor.zonneplan_current_electricity_tariff')|float(0)|round(4) }}"
          belasting: 0.11
          btw_percentage: 21
        
      - name: "Vergelijking met Gemiddeld"
        unique_id: comparison_with_average
        state: >
          {% set current = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
          {% set forecast_prices = [] %}
          
          {% for i in range(1, 9) %}
            {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
            {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
              {% set forecast_prices = forecast_prices + [states(sensor_name)|float(0)] %}
            {% endif %}
          {% endfor %}
          
          {% if forecast_prices|length > 0 %}
            {% set avg = forecast_prices|sum / forecast_prices|length %}
            {% set diff = ((current - avg) / avg * 100)|round(1) %}
            {% if diff > 0 %}
              {{ diff }}% duurder dan gemiddeld
            {% elif diff < 0 %}
              {{ diff|abs }}% goedkoper dan gemiddeld
            {% else %}
              Gelijk aan gemiddeld
            {% endif %}
          {% else %}
            Niet beschikbaar
          {% endif %}
        icon: mdi:chart-line-variant
        attributes:
          percentage_difference: >
            {% set current = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
            {% set forecast_prices = [] %}
            
            {% for i in range(1, 9) %}
              {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
              {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
                {% set forecast_prices = forecast_prices + [states(sensor_name)|float(0)] %}
              {% endif %}
            {% endfor %}
            
            {% if forecast_prices|length > 0 %}
              {% set avg = forecast_prices|sum / forecast_prices|length %}
              {% set diff = ((current - avg) / avg * 100)|round(1) %}
              {{ diff }}
            {% else %}
              0
            {% endif %}
          
      - name: "Minimum Vandaag"
        unique_id: minimum_today
        state: >
          {% set prices = [] %}
          {% set current = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
          {% set prices = [current] %}
          
          {% for i in range(1, 9) %}
            {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
            {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
              {% set prices = prices + [states(sensor_name)|float(0)] %}
            {% endif %}
          {% endfor %}
          
          {% if prices|length > 0 %}
            {{ prices|min|round(4) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state_class: total
        icon: mdi:arrow-down-bold
        attributes:
          forecasted_hours: >
            {% set prices = [] %}
            {% set hours = [] %}
            {% set current_hour = now().hour %}
            
            {% for i in range(1, 9) %}
              {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
              {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
                {% set prices = prices + [states(sensor_name)|float(0)] %}
                {% set hours = hours + [current_hour + i] %}
              {% endif %}
            {% endfor %}
            
            {% if prices|length > 0 %}
              {{ hours|length }}
            {% else %}
              0
            {% endif %}
        
      - name: "Maximum Vandaag"
        unique_id: maximum_today
        state: >
          {% set prices = [] %}
          {% set current = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
          {% set prices = [current] %}
          
          {% for i in range(1, 9) %}
            {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
            {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
              {% set prices = prices + [states(sensor_name)|float(0)] %}
            {% endif %}
          {% endfor %}
          
          {% if prices|length > 0 %}
            {{ prices|max|round(4) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state_class: total
        icon: mdi:arrow-up-bold
        
      - name: "Gemiddeld Vandaag"
        unique_id: average_today
        state: >
          {% set prices = [] %}
          {% set current = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
          {% set prices = [current] %}
          
          {% for i in range(1, 9) %}
            {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
            {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
              {% set prices = prices + [states(sensor_name)|float(0)] %}
            {% endif %}
          {% endfor %}
          
          {% if prices|length > 0 %}
            {{ (prices|sum / prices|length)|round(4) }}
          {% else %}
            0
          {% endif %}
        unit_of_measurement: "€/kWh"
        device_class: monetary
        state_class: total
        icon: mdi:calculator
        attributes:
          tarief_spreiding: >
            {% set prices = [] %}
            {% set current = states('sensor.zonneplan_current_electricity_tariff')|float(0) %}
            {% set prices = [current] %}
            
            {% for i in range(1, 9) %}
              {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
              {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
                {% set prices = prices + [states(sensor_name)|float(0)] %}
              {% endif %}
            {% endfor %}
            
            {% if prices|length > 0 %}
              {% set min_price = prices|min %}
              {% set max_price = prices|max %}
              {% set avg_price = prices|sum / prices|length %}
              {% set spread = max_price - min_price %}
              {% set volatility = (spread / avg_price * 100)|round(1) %}
              {
                "min": {{ min_price|round(4) }},
                "max": {{ max_price|round(4) }},
                "avg": {{ avg_price|round(4) }},
                "spread": {{ spread|round(4) }},
                "volatility_pct": {{ volatility }}
              }
            {% else %}
              {}
            {% endif %}