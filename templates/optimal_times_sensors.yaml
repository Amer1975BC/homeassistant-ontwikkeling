  - sensor:
      - name: "Goedkoopste Uur Vandaag"
        unique_id: cheapest_hour_today
        icon: mdi:clock-time-eight-outline
        state: >
          {% set prices = {} %}
          {% set current_hour = now().hour %}
          
          {# Verzamel alle prijzen voor vandaag inclusief forecasts #}
          {% for i in range(1, 9) %}
            {% set h = current_hour + i %}
            {% if h < 24 %}
              {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
              {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
                {% set prices = prices|combine({h: states(sensor_name)|float(0)}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% if prices|length > 0 %}
            {% set min_hour = 0 %}
            {% set min_price = 999 %}
            {% for hour, price in prices.items() %}
              {% if price < min_price %}
                {% set min_price = price %}
                {% set min_hour = hour %}
              {% endif %}
            {% endfor %}
            {{ min_hour }}:00 - {{ (min_hour + 1) }}:00 (€{{ min_price | round(4) }}/kWh)
          {% else %}
            Geen data beschikbaar
          {% endif %}

      - name: "Goedkoopste 3 Uren Vandaag"
        unique_id: cheapest_three_hours_today
        icon: mdi:clock-time-three-outline
        state: >
          {% set prices = {} %}
          {% set current_hour = now().hour %}
          
          {# Verzamel alle prijzen voor vandaag inclusief forecasts #}
          {% for i in range(1, 9) %}
            {% set h = current_hour + i %}
            {% if h < 24 %}
              {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
              {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
                {% set prices = prices|combine({h: states(sensor_name)|float(0)}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% if prices|length >= 3 %}
            {% set price_list = [] %}
            {% for hour, price in prices.items() %}
              {% set price_list = price_list + [(hour, price)] %}
            {% endfor %}
            
            {% set sorted_list = price_list|sort(attribute='1') %}
            {% set cheapest_three = sorted_list[:3] %}
            
            {% set result_string = "" %}
            {% for pair in cheapest_three %}
              {% set hour = pair[0] %}
              {% set price = pair[1] %}
              {% if loop.first %}
                {% set result_string = hour ~ ":00 (€" ~ price|round(4) ~ ")" %}
              {% else %}
                {% set result_string = result_string ~ ", " ~ hour ~ ":00 (€" ~ price|round(4) ~ ")" %}
              {% endif %}
            {% endfor %}
            
            {{ result_string }}
          {% else %}
            Geen data beschikbaar
          {% endif %}

      - name: "Beste Tijd voor Batterij Laden"
        unique_id: best_time_battery_charging
        icon: mdi:battery-charging
        state: >
          {% set prices = {} %}
          {% set current_hour = now().hour %}
          
          {# Verzamel alle prijzen voor vandaag inclusief forecasts #}
          {% for i in range(1, 9) %}
            {% set h = current_hour + i %}
            {% if h < 24 %}
              {% set sensor_name = 'sensor.zonneplan_forecast_tariff_hour_' ~ i %}
              {% if states(sensor_name) != 'unknown' and states(sensor_name) != 'unavailable' %}
                {% set prices = prices|combine({h: states(sensor_name)|float(0)}) %}
              {% endif %}
            {% endif %}
          {% endfor %}
          
          {% if prices|length > 0 %}
            {% set min_hour = 0 %}
            {% set min_price = 999 %}
            {% for hour, price in prices.items() %}
              {% if price < min_price %}
                {% set min_price = price %}
                {% set min_hour = hour %}
              {% endif %}
            {% endfor %}
            
            {% set low_threshold = 0.15 %}
            {% if min_price < low_threshold %}
              {{ "Vandaag " ~ min_hour ~ ":00 - " ~ (min_hour + 1) ~ ":00 (€" ~ min_price|round(4) ~ ")" }}
            {% else %}
              Wacht op lagere prijzen
            {% endif %}
          {% else %}
            Geen data beschikbaar
          {% endif %}